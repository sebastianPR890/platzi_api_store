{% extends 'base.html' %}

{% block title %}Editar Producto{% endblock %}

{% block content %}
    <h2>Editar Producto</h2>
    <div id="loading">Cargando datos del producto...</div>
    <div id="error" style="display: none; color: red;"></div>

    <form id="productUpdateForm" class="card" style="display: none;">
        <div class="form-group">
            <label for="title">Título:</label>
            <input type="text" id="title" name="title" required>
        </div>
        <div class="form-group">
            <label for="price">Precio:</label>
            <input type="number" id="price" name="price" required>
        </div>
        <div class="form-group">
            <label for="description">Descripción:</label>
            <textarea id="description" name="description" required></textarea>
        </div>
        <div class="form-group">
            <label for="categoryId">Categoría ID:</label>
            <input type="number" id="categoryId" name="categoryId" required>
        </div>
        <div class="form-group">
            <label for="image">URL de la Imagen:</label>
            <input type="text" id="image" name="image" required>
        </div>
        <button type="submit" class="btn btn-primary">Actualizar Producto</button>
        <a href="{% url 'product_detail' product_id %}" class="btn btn-secondary" style="margin-left: 10px;">Cancelar</a>
    </form>
    
    <div id="result"></div>
    
    <script>
        const productId = {{ product_id }};
        const form = document.getElementById('productUpdateForm');
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');

        // 1. Cargar los datos actuales del producto en el formulario
        function loadProductData() {
            fetch(`/api/product/${productId}/`)
                .then(response => response.json())
                .then(data => {
                    loadingDiv.style.display = 'none';
                    if (data.success) {
                        const product = data.product;
                        document.getElementById('title').value = product.name;
                        document.getElementById('price').value = product.price;
                        document.getElementById('description').value = product.description;
                        // Cargar los nuevos campos
                        document.getElementById('categoryId').value = product.categoryId;
                        document.getElementById('image').value = product.image;
                        form.style.display = 'block';
                    } else {
                        showError(data.error);
                    }
                })
                .catch(err => {
                    loadingDiv.style.display = 'none';
                    showError('Error al cargar los datos del producto: ' + err.message);
                });
        }

        // 2. Enviar los datos actualizados a la API
        function handleUpdate(event) {
            event.preventDefault();
            
            const updatedProduct = {
                title: document.getElementById("title").value,
                price: document.getElementById("price").value,
                description: document.getElementById("description").value,
                categoryId: document.getElementById("categoryId").value,
                image: document.getElementById("image").value,
            };
            
            fetch(`/api/product/update/${productId}/`, {
                method: "PUT",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(updatedProduct)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("Producto actualizado con éxito.");
                    window.location.href = `/product/${productId}/`; // Redirigir a la página de detalles
                } else {
                    alert("Error al actualizar: " + data.error);
                }
            })
            .catch(err => alert("Error al enviar la actualización: " + err.message));
        }

        window.addEventListener('load', loadProductData);
        form.addEventListener('submit', handleUpdate);
    </script>

{% endblock %}