{% extends 'base.html' %}

{% block title %}Detalle del Producto{% endblock %}

{% block content %}
    <div id="product-details" class="card" style="display: none;">
        <h1 id="product-name"></h1>
        <img id="product-image" src="" alt="Imagen del producto" width="200">
        <p><strong>ID:</strong> <span id="product-id"></span></p>
        <p><strong>Precio:</strong> $<span id="product-price"></span></p>
        <p><strong>Descripción:</strong></p>
        <p id="product-description"></p>
        {% if user.is_authenticated %}
        <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
            <a id="edit-product-link" class="btn btn-primary">Editar Producto</a>
            <button id="delete-product-btn" class="btn btn-danger">Eliminar Producto</button>
        </div>
        {% endif %}
    </div>

    <div id="loading" style="display: none;">Cargando...</div>
    <div id="error" style="display: none; color: red;"></div>

    <script>
        const productId = {{ product_id }};

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('product-details').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('error').textContent = message;
            document.getElementById('error').style.display = 'block';
            hideLoading();
        }

        function loadProduct() {
            showLoading();
            fetch(`/api/product/${productId}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        document.getElementById('product-details').style.display = 'block';
                        const product = data.product;
                        document.getElementById('product-name').textContent = product.name;
                        document.getElementById('product-id').textContent = product.id;
                        document.getElementById('product-price').textContent = product.price;
                        document.getElementById('product-description').textContent = product.description;
                        document.getElementById('product-image').src = product.image;
                        document.getElementById('product-image').alt = product.name;
                        document.getElementById('edit-product-link').href = `/product/update/${product.id}/`;
                    } else {
                        showError(data.error);
                    }
                })
                .catch(error => {
                    showError('Error al cargar el producto: ' + error.message);
                });
        }

        function deleteProduct() {
            if (confirm('¿Estás seguro de que quieres eliminar este producto? Esta acción no se puede deshacer.')) {
                showLoading();
                fetch(`/api/product/delete/${productId}/`, {
                    method: 'DELETE',
                })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        alert(data.message);
                        window.location.href = "{% url 'product_list' %}"; // Redirigir a la lista de productos
                    } else {
                        showError('Error al eliminar el producto: ' + data.error);
                    }
                })
                .catch(error => {
                    showError('Error en la solicitud para eliminar el producto: ' + error.message);
                });
            }
        }

        // Ejecutar la función cuando la página cargue
        window.addEventListener('load', loadProduct);
        {% if user.is_authenticated %}
            document.getElementById('delete-product-btn').addEventListener('click', deleteProduct);
        {% endif %}
    </script>
{% endblock %}